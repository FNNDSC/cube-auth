<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-pages/iron-pages.html">

<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">

<link rel="import" href="../chips-api/chips-api.html">

<dom-module id="cube-auth">
  <template>
    <style>
      :host {
        display: block;
        max-width: 364px;
      }
      iron-image {
        width: 150px;
        height: 150px;
        background: #fff;
      }

      .page {
        display: flex;
        flex-direction: column;
      }

      .card-header {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .card-actions {
        display: flex;
      }

      .spacer {
        flex: 1;
      }
    </style>

    <chips-api
      id="API"
      api="ultron"
      api-root="[[serverIp]]:[[serverPort]]/[[serverNamespace]]">
    </chips-api>

    <iron-pages selected="[[page]]" attr-for-selected="page">

      <!-- login card -->
      <div class="page" page="login">
        <paper-card >
          <!-- header content -->
          <div class="card-header">
            <iron-image
              preload
              src="[[appLogo]]"
              fade id="example-preload-image-2"
              alt="The Polymer logo."
              class="sized"
              sizing="contain"></iron-image>
              <div>[[appTitle]]</div>
          </div>

          <!-- inputs -->
          <div class="card-content">
            <paper-input
              id="usernameL"
              type="username"
              value="{{username}}"
              required
              error-message="Username is required"
              label="Username"
              onfocusout="validate()"
              on-keypress="keypressHandler"></paper-input>
            <paper-input
              id="passwordL"
              type$="[[passwordInputType(passwordVisible)]]"
              value="{{password}}"
              required
              error-message="Password is required"
              label="Password"
              onfocusout="validate()"
              on-keypress="keypressHandler">
            
              <paper-icon-button
                slot="suffix"
                on-tap="togglePasswordVisibility"
                icon$="[[passwordInputIcon(passwordVisible)]]" alt="clear" title="clear">
              </paper-icon-button>

            </paper-input>
          </div>

          <!-- actions -->
          <div class="card-actions">
            <paper-button on-tap="signupPage">Sign up</paper-button>
            <div class="spacer"></div>
            <paper-button on-tap="login">Log in</paper-button>
          </div>

        </paper-card>

        <paper-button on-tap="forgotPage">Forgot my password</paper-button>
      </div>

      <!-- signup page -->
      <div class="page" page="signup">
        <paper-card >
          <!-- header content -->
          <div class="card-header">
            <iron-image
              preload
              src="[[appLogo]]"
              fade id="example-preload-image-2"
              alt="The Polymer logo."
              class="sized"
              sizing="contain"></iron-image>
              <div>[[appTitle]]</div>
          </div>

          <!-- inputs -->
          <div class="card-content">
            <paper-input
              id="emailS"
              type="email"
              value="{{email}}"
              required
              error-message="Email is required"
              label="Email"
              onfocusout="validate()"
              on-keypress="keypressHandler"></paper-input>
            <paper-input
              id="usernameS"
              type="username"
              value="{{username}}"
              required
              error-message="Username is required"
              label="Username"
              onfocusout="validate()"
              on-keypress="keypressHandler"></paper-input>
            <paper-input
              id="passwordS"
              type$="[[passwordInputType(passwordVisible)]]"
              value="{{password}}"
              required
              error-message="Password is required"
              label="Password"
              onfocusout="validate()"
              on-keypress="keypressHandler">
              <paper-icon-button
                slot="suffix"
                on-tap="togglePasswordVisibility"
                icon$="[[passwordInputIcon(passwordVisible)]]" alt="clear" title="clear">
              </paper-icon-button>
            </paper-input>
            <paper-input
              id="passwordConfirmationS"
              type="password"
              value="{{passwordConfirmation}}"
              required
              error-message="Password is required"
              label="Confirm Password"
              on-keyup="passwordConfirmationHandler"></paper-input>
          </div>

          <!-- actions -->
          <div class="card-actions">
            <paper-button on-tap="loginPage">Back</paper-button>
            <div class="spacer"></div>
            <paper-button on-tap="signup">Sign up</paper-button>
          </div>
  
        </paper-card>
      </div>

      <!-- forgot page -->
      <div class="page" page="forgot">
        <paper-card >
          <!-- header content -->
          <div class="card-header">
            <iron-image
              preload
              src="[[appLogo]]"
              fade id="example-preload-image-2"
              alt="The Polymer logo."
              class="sized"
              sizing="contain"></iron-image>
              <div>[[appTitle]]</div>
          </div>

          <!-- inputs -->
          <div class="card-content">
            <paper-input
              id="emailF"
              type="email"
              value="{{email}}"
              required
              error-message="Email is required"
              label="Email"
              onfocusout="validate()"
              on-keypress="keypressHandler"></paper-input>
          </div>

          <!-- actions -->
          <div class="card-actions">
            <paper-button on-tap="loginPage">Back</paper-button>
            <div class="spacer"></div>
            <paper-button on-tap="forgot">Reset password</paper-button>
          </div>
    
        </paper-card>
      </div>

    </iron-pages>
  </template>

  <script>
    /**
     * `cube-auth`
     * Element to login against CUBE
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CubeAuth extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'cube-auth'; }
      static get properties() {
        return {
          appLogo: {
            String,
            value: '',
          },
          appTitle: {
            String,
            value: '',
          },
          email: {
            type: String,
            value: '',
          },
          username: {
            type: String,
            value: '',
          },
          password: {
            type: String,
            value: '',
          },
          passwordConfirmation: {
            type: String,
            value: '',
          },
          passwordVisible: {
            type: Boolean,
            value: false,
          },
          token: {
            type: String,
            value: 'iamthetoken',
          },
          serverIp: {
            type: String,
            value: '',
            observer: '_serverAddressChanged',
          },
          serverPort: {
            type: String,
            value: '',
            observer: '_serverAddressChanged',
          },
          serverNamespace: {
            type: String,
            value: '',
            observer: '_serverAddressChanged',
          },
          page: {
            type: String,
            value: 'login',
          },
          online: {
            type: Boolean,
            value: false,
          },
        };
      }

      keypressHandler(evt) {
        if (evt.charCode === 13) {
          // try to log in
          this.login();
        }
      }

      login() {
        this.$.usernameL.validate();
        this.$.passwordL.validate();
        if (!this.$.usernameL.invalid &&
            !this.$.passwordL.invalid) {
          // prepare data
          const data = {};
          data.auth = {
            type: 'none',
          };
          data.body = {
            'username': this.username,
            'password': this.password,
          };
          // need to pass username and password
          const request = this.$.API.request('POST', 'login', data);

          // behavior on invalid login?
          request
            .then(this.handleResponse.bind(this))
            .catch(this.handleError.bind(this));
          }
      }

      signup() {
        this.$.emailS.validate();
        this.$.usernameS.validate();
        this.$.passwordS.validate();
        this.$.passwordConfirmationS.validate();
        if (!this.$.emailS.invalid &&
            !this.$.usernameS.invalid &&
            !this.$.passwordS.invalid &&
            !this.$.passwordConfirmationS.invalid) {
          console.log('go signup!');
          // then
          this.loginPage();
        }
      }

      forgot() {
        this.$.emailF.validate();
        if (!this.$.emailF.invalid) {
          console.log('go forgot!');
          // then
          this.loginPage();
        }
      }

      _serverAddressChanged() {
        // just ping server to make sure it is online
        console.log(`${this.serverIp}:${this.serverPort}/${this.serverNamespace}`);
      }

      handleResponse(response) {
        console.log(response);
      }

      handleError(error) {
        console.log(error);
      }

      loginPage() {
        this.resetPassword();
        this.page = 'login';
      }

      signupPage() {
        this.resetPassword();
        this.page = 'signup';
      }

      forgotPage() {
        this.resetPassword();
        this.page = 'forgot';
      }

      resetPassword() {
        this.passwordVisible = false;
        this.password= '';
        this.passwordConfirmation = '';
      }

      togglePasswordVisibility() {
        this.passwordVisible = !this.passwordVisible;
      }

      passwordInputIcon(visible) {
        return visible ? 'icons:visibility-off' : 'icons:visibility';
      }

      passwordInputType(visible) {
        return visible ? 'text' : 'password';
      }

      passwordConfirmationHandler() {
        this.$.passwordConfirmationS.invalid = this.password !== this.passwordConfirmation;
      }
    }

    window.customElements.define(CubeAuth.is, CubeAuth);
  </script>
</dom-module>
